/**
 * –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏ –æ—Å—Ç–∞—Ç–∫–æ–≤ FBO (—Å–∫–ª–∞–¥—ã WB)
 * –∏–∑ Statistics API Wildberries –≤ —Ç–µ–∫—É—â—É—é Google-—Ç–∞–±–ª–∏—Ü—É.
 *
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –º–µ—Ç–æ–¥:
 *   GET https://statistics-api.wildberries.ru/api/v1/supplier/stocks
 * —Å—Ç—Ä–æ–≥–æ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.
 *
 * –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
 * 1. –í Google –¢–∞–±–ª–∏—Ü–∞—Ö —Å–æ–∑–¥–∞–π—Ç–µ –ª–∏—Å—Ç —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º "API".
 * 2. –í —è—á–µ–π–∫—É A1 —ç—Ç–æ–≥–æ –ª–∏—Å—Ç–∞ –≤—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à —Ç–æ–∫–µ–Ω Wildberries –¥–ª—è Statistics API.
 * 3. –í Google –¢–∞–±–ª–∏—Ü–∞—Ö –æ—Ç–∫—Ä–æ–π—Ç–µ: –†–∞—Å—à–∏—Ä–µ–Ω–∏—è ‚Üí Apps Script.
 * 4. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç –∏ –≤—Å—Ç–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥.
 * 5. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç.
 * 6. –í Apps Script –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é onOpen() (–∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É),
 *    –ø–æ—è–≤–∏—Ç—Å—è –º–µ–Ω—é "WB FBO".
 * 7. –í —Ç–∞–±–ª–∏—Ü–µ: –ú–µ–Ω—é "WB FBO" ‚Üí "–í—ã–≥—Ä—É–∑–∏—Ç—å –æ—Å—Ç–∞—Ç–∫–∏ FBO".
 */

// –ë–∞–∑–æ–≤—ã–π URL Statistics API WB
const WB_STAT_BASE_URL = 'https://statistics-api.wildberries.ru';

/**
 * –ß–∏—Ç–∞–µ—Ç —Ç–æ–∫–µ–Ω WB API —Å –ª–∏—Å—Ç–∞ "API" –∏–∑ —è—á–µ–π–∫–∏ A1
 */
function getWBApiKey_() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName('API');
  if (!sheet) {
    throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω –ª–∏—Å—Ç "API". –°–æ–∑–¥–∞–π—Ç–µ –ª–∏—Å—Ç —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º –∏ –ø–æ–º–µ—Å—Ç–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤ —è—á–µ–π–∫—É A1.');
  }
  const value = sheet.getRange('A1').getValue();
  const apiKey = String(value || '').trim();
  if (!apiKey) {
    throw new Error('–í —è—á–µ–π–∫–µ API!A1 –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞ WB API. –£–∫–∞–∂–∏—Ç–µ —Ç—É–¥–∞ —Ç–æ–∫–µ–Ω Statistics API.');
  }
  return apiKey;
}

/**
 * –ú–µ–Ω—é –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ç–∞–±–ª–∏—Ü—ã
 */
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('WB FBO')
    .addItem('üì¶ –í—ã–≥—Ä—É–∑–∏—Ç—å –æ—Å—Ç–∞—Ç–∫–∏ FBO', 'exportWBFBOStocksToSheet')
    .addToUi();
}

/**
 * –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –≤—ã–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –æ—Å—Ç–∞—Ç–∫–∏ FBO –≤ –∞–∫—Ç–∏–≤–Ω—ã–π –ª–∏—Å—Ç
 */
function exportWBFBOStocksToSheet() {
  try {
    const apiKey = getWBApiKey_();

    Logger.log('–ù–∞—á–∏–Ω–∞–µ–º –≤—ã–≥—Ä—É–∑–∫—É –æ—Å—Ç–∞—Ç–∫–æ–≤ FBO —á–µ—Ä–µ–∑ supplier/stocks...');
    Logger.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–∫–µ–Ω: ***' + apiKey.slice(-4));

    const allStocks = loadAllFBOStocks_(apiKey);
    Logger.log('–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π –æ—Å—Ç–∞—Ç–∫–æ–≤: ' + allStocks.length);

    writeStocksToSheet_(allStocks);
    SpreadsheetApp.getUi().alert(
      '–í—ã–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞',
      '–ó–∞–ø–∏—Å–∞–Ω–æ —Å—Ç—Ä–æ–∫: ' + allStocks.length,
      SpreadsheetApp.getUi().ButtonSet.OK
    );
  } catch (e) {
    Logger.log('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ FBO: ' + e);
    SpreadsheetApp.getUi().alert(
      '–û—à–∏–±–∫–∞',
      '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ FBO: ' + e.message,
      SpreadsheetApp.getUi().ButtonSet.OK
    );
  }
}

/**
 * –í —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π:
 * - –±–µ—Ä—ë–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ä–∞–Ω–Ω—é—é –¥–∞—Ç—É –≤ dateFrom,
 * - –¥–µ–ª–∞–µ–º –ø–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å;
 * - –≤ –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –≤ dateFrom –ø–µ—Ä–µ–¥–∞–µ–º –ø–æ–ª–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
 *   lastChangeDate –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–æ–∫–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞;
 * - –∫–∞–∫ —Ç–æ–ª—å–∫–æ API –≤–µ—Ä–Ω—É–ª–æ [], –≤—Å–µ –æ—Å—Ç–∞—Ç–∫–∏ –≤—ã–≥—Ä—É–∂–µ–Ω—ã.
 *
 * –í–ê–ñ–ù–û –ø–æ –ª–∏–º–∏—Ç–∞–º:
 *   1 –∑–∞–ø—Ä–æ—Å –≤ –º–∏–Ω—É—Ç—É –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç –ø—Ä–æ–¥–∞–≤—Ü–∞.
 * –ü–æ—ç—Ç–æ–º—É –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ (–∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–≥–æ) –¥–µ–ª–∞–µ–º –ø–∞—É–∑—É ~60 —Å–µ–∫—É–Ω–¥.
 */
function loadAllFBOStocks_(apiKey) {
  let dateFrom = '2019-06-20T00:00:00'; // –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ä–∞–Ω–Ω—è—è –¥–∞—Ç–∞, –∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–∞—Ö
  let allData = [];
  let iteration = 0;

  while (true) {
    iteration++;
    Logger.log('–ó–∞–ø—Ä–æ—Å #' + iteration + ' —Å dateFrom=' + dateFrom);

    const batch = fetchStocksBatch_(dateFrom, apiKey);

    if (!batch || batch.length === 0) {
      Logger.log('–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç ([]). –í—Å–µ –æ—Å—Ç–∞—Ç–∫–∏ –≤—ã–≥—Ä—É–∂–µ–Ω—ã.');
      break;
    }

    Logger.log('–ü–æ–ª—É—á–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π –≤ –±–∞—Ç—á–µ: ' + batch.length);
    allData = allData.concat(batch);

    const last = batch[batch.length - 1];
    const lastChange = last.lastChangeDate;

    if (!lastChange) {
      Logger.log('–í –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–ø–∏—Å–∏ –Ω–µ—Ç lastChangeDate, –ø—Ä–µ–∫—Ä–∞—â–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é.');
      break;
    }

    // –ü–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏, –≤–æ –≤—Ç–æ—Ä–æ–º –∏ –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –Ω—É–∂–Ω–æ –ø–æ–¥—Å—Ç–∞–≤–ª—è—Ç—å
    // –ø–æ–ª–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ lastChangeDate –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–æ–∫–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞.
    dateFrom = lastChange;

    // –£—á–∏—Ç—ã–≤–∞–µ–º –ª–∏–º–∏—Ç: 1 –∑–∞–ø—Ä–æ—Å –≤ –º–∏–Ω—É—Ç—É.
    // –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å —É–∂–µ —Å–¥–µ–ª–∞–Ω; –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º–∏ ‚Äî –ø–∞—É–∑–∞ ~60 —Å–µ–∫—É–Ω–¥.
    Logger.log('–ñ–¥—ë–º 60 —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º –∑–∞–ø—Ä–æ—Å–æ–º –¥–ª—è —Å–æ–±–ª—é–¥–µ–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤...');
    Utilities.sleep(60000);
  }

  return allData;
}

/**
 * –î–µ–ª–∞–µ—Ç –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –∫ /api/v1/supplier/stocks
 * @param {string} dateFrom - –∑–Ω–∞—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ dateFrom –≤ —Ñ–æ—Ä–º–∞—Ç–µ RFC3339
 * @param {string} apiKey - —Ç–æ–∫–µ–Ω WB
 * @returns {Array<Object>} –º–∞—Å—Å–∏–≤ –æ—Å—Ç–∞—Ç–∫–æ–≤
 */
function fetchStocksBatch_(dateFrom, apiKey) {
  const url = WB_STAT_BASE_URL + '/api/v1/supplier/stocks?dateFrom=' + encodeURIComponent(dateFrom);

  const options = {
    method: 'get',
    headers: {
      'Authorization': apiKey,
      'Content-Type': 'application/json'
    },
    muteHttpExceptions: true
  };

  Logger.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å: ' + url);
  const resp = UrlFetchApp.fetch(url, options);
  const code = resp.getResponseCode();
  Logger.log('–ö–æ–¥ –æ—Ç–≤–µ—Ç–∞: ' + code);

  if (code === 429) {
    throw new Error('–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ (429). –ü–æ–¥–æ–∂–¥–∏—Ç–µ 1-2 –º–∏–Ω—É—Ç—ã –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
  }

  if (code < 200 || code >= 300) {
    throw new Error('API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É ' + code + ': ' + resp.getContentText());
  }

  const text = resp.getContentText();
  if (!text) {
    return [];
  }

  const json = JSON.parse(text);
  if (Array.isArray(json)) {
    return json;
  }

  // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –≤–µ—Ä–Ω—ë—Ç—Å—è –æ–±—ä–µ–∫—Ç —Å –ø–æ–ª–µ–º stocks
  if (json && Array.isArray(json.stocks)) {
    return json.stocks;
  }

  return [];
}

/**
 * –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –æ—Å—Ç–∞—Ç–∫–∏ –≤ –∞–∫—Ç–∏–≤–Ω—ã–π –ª–∏—Å—Ç
 * @param {Array<Object>} stocks
 */
function writeStocksToSheet_(stocks) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getActiveSheet();

  sheet.clearContents();

  if (!stocks || stocks.length === 0) {
    sheet.getRange(1, 1).setValue('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –æ—Å—Ç–∞—Ç–∫–∞—Ö FBO.');
    return;
  }

  const headers = [
    'lastChangeDate',
    'warehouseName',
    'supplierArticle',
    'nmId',
    'barcode',
    'quantity',
    'inWayToClient',
    'inWayFromClient',
    'quantityFull',
    'category',
    'subject',
    'brand',
    'techSize',
    'Price',
    'Discount',
    'isSupply',
    'isRealization',
    'SCCode'
  ];

  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  sheet.getRange(1, 1, 1, headers.length)
    .setFontWeight('bold')
    .setBackground('#4285f4')
    .setFontColor('#ffffff');

  const rows = stocks.map(function (s) {
    return [
      s.lastChangeDate || '',
      s.warehouseName || '',
      s.supplierArticle || '',
      s.nmId || '',
      s.barcode || '',
      s.quantity || 0,
      s.inWayToClient || 0,
      s.inWayFromClient || 0,
      s.quantityFull || '',
      s.category || '',
      s.subject || '',
      s.brand || '',
      s.techSize || '',
      s.Price || '',
      s.Discount || '',
      s.isSupply || false,
      s.isRealization || false,
      s.SCCode || ''
    ];
  });

  sheet.getRange(2, 1, rows.length, headers.length).setValues(rows);
  sheet.autoResizeColumns(1, headers.length);

  sheet.getRange(rows.length + 3, 1)
    .setValue('–û–±–Ω–æ–≤–ª–µ–Ω–æ: ' + new Date().toLocaleString('ru-RU'));
}

